variables:
  # format is <branch>=<name>
  # the name is used in the URL
  # latest release must be at the top
  # (only relevant on main branch)
  RELEASES: |
    v0.1=0.1.0-alpha-6
    v0.1=0.1.0-alpha-5
    v0.1=0.1.0-alpha-4
    v0.1=0.1.0-alpha-3
    v0.1=0.1.0-alpha-2
    v0.1=0.1.0-alpha

image: "debian:testing"

before_script:
  - apt update; apt install -y --no-install-recommends git build-essential curl ca-certificates meson cmake libgtk-4-dev libnghttp2-dev libsqlite3-dev libpsl-dev glib-networking valac gtk-doc-tools ruby-dev libgcrypt20-dev libxml2-dev libatk1.0-dev libwebp-dev libatspi2.0-dev libwpe-1.0-dev libwpebackend-fdo-1.0-dev libmanette-0.2-dev libxslt1-dev libsecret-1-dev libtasn1-6-dev libenchant-2-dev libxt-dev libnotify-dev libhyphen-dev libopenjp2-7-dev libwoff-dev libavif-dev libsystemd-dev liblcms2-dev libwrap0-dev bubblewrap libseccomp-dev xdg-dbus-proxy libgstreamer-plugins-base1.0-dev libgstreamer-plugins-bad1.0-dev gperf gettext
  # compile libsoup3
  - git clone --recursive https://gitlab.gnome.org/GNOME/libsoup
  - cd libsoup
  - meson build -Dprefix=/usr -Dbrotli=enabled -Dgtk_doc=true -Dinstalled_tests=true -Dvapi=enabled
  - cd build
  - ninja install
  - cd ../../

  # compile webkit2gtk5
  - git clone --recursive https://salsa.debian.org/webkit-team/webkit.git
  - mkdir -p webkit/build
  - cd webkit/build
  - cmake -DUSE_GTK4=ON -DPORT=GTK -DUSE_SOUP2=OFF -DUSE_AVIF=ON -DENABLE_GLES2=ON -DENABLE_MINIBROWSER=ON -DCMAKE_INSTALL_PREFIX=/usr ..
  - make -j8 install
  - cd ../../

  - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain none -y
  - source $HOME/.cargo/env
  - rustup toolchain install nightly --profile minimal --allow-downgrade -c rustfmt

  - git submodule update --init
  - curl --proto '=https' --tlsv1.2 -sSf -o gir-rustdoc.py
    https://gitlab.gnome.org/World/Rust/gir-rustdoc/-/raw/main/gir-rustdoc.py
  - chmod +x gir-rustdoc.py

build:
  script:
    - cargo build --all-features --examples
    - cargo test

docs:
  stage: test
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
  script:
    # generate the docs
    - cargo install rustdoc-stripper
    - ./generator.py --embed-docs
    - rustup default nightly
    - eval $(./gir-rustdoc.py pre-docs)
    - cargo doc --features dox --no-deps
    - mv target/doc/ docs
  artifacts:
    paths:
      - docs

pages:
  stage: deploy
  script:
    - ./gir-rustdoc.py html-index
    # main docs
    - mkdir public/git
    - mv docs public/git/docs
    # stable docs
    # - ./gir-rustdoc.py docs-from-artifacts
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_DEFAULT_BRANCH == $CI_COMMIT_BRANCH
